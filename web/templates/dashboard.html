{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
.clickable-card {
    transition: all 0.3s ease;
    position: relative;
}

.clickable-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2) !important;
}

.clickable-card:active {
    transform: translateY(-2px);
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <i class="bi bi-speedometer2"></i> Dashboard
    </h1>
    <p class="text-muted mb-0">Welcome back, {{ session.username|default('User') }}!</p>
</div>

<!-- Statistics Cards -->
<div class="row">
    <div class="col-md-3">
        <div class="stat-card bg-primary text-white clickable-card" onclick="showUsers()" style="cursor: pointer;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="label">Total Users</div>
                    <div class="value">{{ stats.total_users }}</div>
                </div>
                <div class="icon">
                    <i class="bi bi-people"></i>
                </div>
            </div>
            <small class="mt-2 d-block opacity-75">
                <i class="bi bi-hand-index"></i> Click to manage
            </small>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card bg-success text-white clickable-card" onclick="showDepartments()" style="cursor: pointer;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="label">Departments</div>
                    <div class="value">{{ stats.total_departments }}</div>
                </div>
                <div class="icon">
                    <i class="bi bi-diagram-3"></i>
                </div>
            </div>
            <small class="mt-2 d-block opacity-75">
                <i class="bi bi-hand-index"></i> Click to manage
            </small>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card bg-info text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="label">Total Reports</div>
                    <div class="value">{{ stats.total_reports }}</div>
                </div>
                <div class="icon">
                    <i class="bi bi-file-text"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card bg-warning text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="label">Pending</div>
                    <div class="value">{{ stats.pending_reports }}</div>
                </div>
                <div class="icon">
                    <i class="bi bi-clock-history"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightning"></i> Quick Actions
            </div>
            <div class="card-body">
                <div class="row">
                    {% if user_role.role_name == 'admin' %}
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#createAdminModal">
                            <i class="bi bi-person-plus"></i><br>
                            Create Admin
                        </button>
                    </div>

                    <div class="col-md-3 mb-3">
                        <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#promoteUserModal">
                            <i class="bi bi-arrow-up-circle"></i><br>
                            Promote User
                        </button>
                    </div>
                    {% endif %}

                    {% if user_role.role_name in ['manager', 'upper_manager', 'admin'] %}
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#createDeptModal">
                            <i class="bi bi-folder-plus"></i><br>
                            Create Department
                        </button>
                    </div>
                    {% endif %}

                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('reports_list') }}" class="btn btn-secondary w-100">
                            <i class="bi bi-file-earmark-text"></i><br>
                            View Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-activity"></i> Recent Activity
            </div>
            <div class="card-body">
                {% if recent_activity %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in recent_activity %}
                            <tr>
                                <td>
                                    <div class="user-avatar">
                                        {{ activity.username[0]|upper if activity.username else 'U' }}
                                    </div>
                                    {{ activity.username|default('Unknown') }}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ activity.action_type }}</span>
                                </td>
                                <td>{{ activity.details|truncate(50) }}</td>
                                <td>{{ activity.timestamp }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center mb-0">No recent activity</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
{% if user_role.role_name == 'admin' %}
<!-- Create Admin Modal -->
<div class="modal fade" id="createAdminModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus"></i> Create Administrator
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createAdminForm">
                    <div class="mb-3">
                        <label for="admin_user_id" class="form-label">User ID</label>
                        <input type="number" class="form-control" id="admin_user_id" required>
                        <small class="form-text text-muted">Telegram user ID of the user to make admin</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createAdmin()">Create Admin</button>
            </div>
        </div>
    </div>
</div>

<!-- Promote User Modal -->
<div class="modal fade" id="promoteUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-up-circle"></i> Promote User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="promoteUserForm">
                    <div class="mb-3">
                        <label for="promote_user_id" class="form-label">User ID</label>
                        <input type="number" class="form-control" id="promote_user_id" required>
                    </div>
                    <div class="mb-3">
                        <label for="promote_role" class="form-label">New Role</label>
                        <select class="form-select" id="promote_role" required>
                            <option value="manager">Manager</option>
                            <option value="upper_manager">Upper Manager</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="promoteUser()">Promote</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Users Management Modal -->
<div class="modal fade" id="usersModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-people"></i> Manage Users
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="usersModalBody">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Departments Management Modal -->
<div class="modal fade" id="departmentsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-diagram-3"></i> Manage Departments
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="departmentsModalBody">
                <div class="text-center">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if user_role.role_name in ['manager', 'upper_manager', 'admin'] %}
<!-- Create Department Modal -->
<div class="modal fade" id="createDeptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-folder-plus"></i> Create Department
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createDeptForm">
                    <div class="mb-3">
                        <label for="dept_name_ar" class="form-label">Arabic Name</label>
                        <input type="text" class="form-control" id="dept_name_ar" required>
                    </div>
                    <div class="mb-3">
                        <label for="dept_name_en" class="form-label">English Name</label>
                        <input type="text" class="form-control" id="dept_name_en" required>
                    </div>
                    <div class="mb-3">
                        <label for="dept_parent" class="form-label">Parent Department (Optional)</label>
                        <input type="number" class="form-control" id="dept_parent" placeholder="Leave empty for root department">
                    </div>
                    <div class="mb-3">
                        <label for="dept_description" class="form-label">Description</label>
                        <textarea class="form-control" id="dept_description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="createDepartment()">Create</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function showUsers() {
    const modal = new bootstrap.Modal(document.getElementById('usersModal'));
    modal.show();

    // Fetch users
    fetch('/api/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const users = data.users;
                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                users.forEach(user => {
                    const statusBadge = user.is_active ?
                        '<span class="badge bg-success">Active</span>' :
                        '<span class="badge bg-secondary">Inactive</span>';

                    const actionBtn = user.user_id != {{ session.user_id }} ?
                        (user.is_active ?
                            `<button class="btn btn-sm btn-warning" onclick="deactivateUser(${user.user_id}, '${user.username}')">
                                <i class="bi bi-person-dash"></i> Deactivate
                            </button>` :
                            `<button class="btn btn-sm btn-success" onclick="activateUser(${user.user_id}, '${user.username}')">
                                <i class="bi bi-person-check"></i> Activate
                            </button>`) :
                        '<span class="text-muted">You</span>';

                    html += `
                        <tr>
                            <td>${user.user_id}</td>
                            <td>${user.username || 'N/A'}</td>
                            <td><a href="/users/${user.user_id}" class="text-decoration-none">${user.first_name || ''} ${user.last_name || ''}</a></td>
                            <td>${user.email || 'N/A'}</td>
                            <td>${user.role || 'employee'}</td>
                            <td>${statusBadge}</td>
                            <td>${actionBtn}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('usersModalBody').innerHTML = html;
            } else {
                document.getElementById('usersModalBody').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> ${data.message || 'Failed to load users'}
                    </div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('usersModalBody').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Error: ${error.message}
                </div>
            `;
        });
}

function showDepartments() {
    const modal = new bootstrap.Modal(document.getElementById('departmentsModal'));
    modal.show();

    // Fetch departments
    fetch('/api/departments')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const departments = data.departments;
                // Create a map for parent lookup
                const deptMap = {};
                departments.forEach(d => deptMap[d.id] = d);

                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name (AR)</th>
                                    <th>Name (EN)</th>
                                    <th>Parent Department</th>
                                    <th>Level</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                departments.forEach(dept => {
                    const statusBadge = dept.is_active ?
                        '<span class="badge bg-success">Active</span>' :
                        '<span class="badge bg-secondary">Inactive</span>';

                    // Find parent department name
                    let parentName = '<span class="text-muted">Root</span>';
                    if (dept.parent_department_id && deptMap[dept.parent_department_id]) {
                        const parent = deptMap[dept.parent_department_id];
                        parentName = `${parent.name} (${parent.name_en || 'N/A'})`;
                    }

                    html += `
                        <tr>
                            <td>${dept.id}</td>
                            <td>${dept.name}</td>
                            <td>${dept.name_en || 'N/A'}</td>
                            <td>${parentName}</td>
                            <td>Level ${dept.level}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="removeDepartment(${dept.id}, '${dept.name}')">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('departmentsModalBody').innerHTML = html;
            } else {
                document.getElementById('departmentsModalBody').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> ${data.message || 'Failed to load departments'}
                    </div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('departmentsModalBody').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Error: ${error.message}
                </div>
            `;
        });
}

function removeUser(userId, username) {
    if (!confirm(`Are you sure you want to remove user "${username}"?`)) {
        return;
    }

    fetch('/users/remove', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `user_id=${userId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            showUsers(); // Reload the list
            location.reload(); // Reload to update stats
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function deactivateUser(userId, username) {
    if (!confirm(`Are you sure you want to deactivate user "${username}"?`)) {
        return;
    }

    fetch('/users/remove', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `user_id=${userId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            showUsers(); // Reload the list
            location.reload(); // Reload to update stats
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function activateUser(userId, username) {
    if (!confirm(`Are you sure you want to activate user "${username}"?`)) {
        return;
    }

    fetch('/users/activate', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `user_id=${userId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            showUsers(); // Reload the list
            location.reload(); // Reload to update stats
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function removeDepartment(deptId, deptName) {
    if (!confirm(`Are you sure you want to remove department "${deptName}"?`)) {
        return;
    }

    fetch('/departments/remove', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `dept_id=${deptId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            showDepartments(); // Reload the list
            location.reload(); // Reload to update stats
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function createAdmin() {
    const userId = document.getElementById('admin_user_id').value;

    fetch('/users/create-admin', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `user_id=${userId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function promoteUser() {
    const userId = document.getElementById('promote_user_id').value;
    const role = document.getElementById('promote_role').value;

    fetch('/users/promote', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `user_id=${userId}&role=${role}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function createDepartment() {
    const nameAr = document.getElementById('dept_name_ar').value;
    const nameEn = document.getElementById('dept_name_en').value;
    const parentId = document.getElementById('dept_parent').value;
    const description = document.getElementById('dept_description').value;

    fetch('/departments/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `name_ar=${encodeURIComponent(nameAr)}&name_en=${encodeURIComponent(nameEn)}&parent_id=${parentId}&description=${encodeURIComponent(description)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    });
}
</script>
{% endblock %}
